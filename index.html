<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Notes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #fff;
      --text: #000;
      --card: #f3f3f3;
      --primary: #007bff;
      --primary-hover: #0056b3;
    }
    body.dark {
      --bg: #121212;
      --text: #fff;
      --card: #1f1f1f;
    }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: auto;
      padding: 20px;
      transition: background-color 0.3s, color 0.3s;
    }
    input, textarea, button {
      width: 100%;
      margin: 8px 0;
      padding: 10px;
      font-size: 16px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: var(--card);
      color: var(--text);
      transition: background-color 0.3s, color 0.3s;
    }
    input::placeholder, textarea::placeholder {
      color: #666;
    }
    button {
      background: var(--primary);
      color: white;
      cursor: pointer;
      border: none;
      transition: background-color 0.3s;
    }
    button:hover {
      background: var(--primary-hover);
    }
    .note {
      background: var(--card);
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s;
    }
    .note:hover {
      background: var(--primary);
      color: white;
    }
    .note h3 {
      margin: 0 0 5px;
      word-break: break-word;
    }
    .note p {
      margin: 0;
      font-size: 14px;
      color: inherit;
      word-break: break-word;
    }
    .note small {
      display: block;
      margin-top: 8px;
      font-size: 12px;
      color: gray;
      user-select: text;
    }
    #themeToggle {
      float: right;
      margin-top: -38px;
      width: auto;
      padding: 8px 12px;
      font-size: 14px;
      border-radius: 20px;
    }
    #noteEditor {
      display: none;
    }
    #searchBox {
      margin-top: 16px;
    }
    img.note-img {
      max-width: 100%;
      margin-top: 10px;
      border-radius: 5px;
    }
    /* New styles for contenteditable div editor */
    #editContent {
      width: 100%;
      min-height: 180px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: var(--card);
      color: var(--text);
      font-family: Arial, sans-serif;
      font-size: 16px;
      overflow-y: auto;
      white-space: pre-wrap;
      outline: none;
    }
    /* Ensure images inside editor scale nicely */
    #editContent img {
      max-width: 100%;
      border-radius: 5px;
      margin: 5px 0;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <h1>My Notes</h1>
  <button id="themeToggle" aria-label="Toggle Dark/Light Theme">🌙 Toggle Theme</button>

  <section id="authSection" aria-label="User Authentication">
    <input type="email" id="email" placeholder="Email" autocomplete="username" />
    <input type="password" id="password" placeholder="Password" autocomplete="current-password" />
    <button id="loginBtn">Login</button>
    <button id="signupBtn">Sign Up</button>
    <button id="resetBtn">Reset Password</button>
  </section>

  <section id="mainMenu" style="display:none;" aria-label="Main Note Taking Area">
    <button id="logoutBtn">Logout</button>
    <input type="text" id="noteTitle" placeholder="Note title" aria-label="Note Title" />
    <textarea id="noteText" rows="3" placeholder="Write your note..." aria-label="Note Content"></textarea>
    <input type="file" id="imageUpload" accept="image/*" />
    <button id="uploadImageBtn">Upload Image</button>
    <button id="saveNoteBtn">Save Note</button>

    <input type="text" id="searchBox" placeholder="Search notes..." aria-label="Search Notes" />

    <h2>Your Notes</h2>
    <div id="notesContainer" aria-live="polite" aria-relevant="additions"></div>
  </section>

  <section id="noteEditor" aria-label="Edit Note">
    <button id="backBtn" aria-label="Back to Notes List">⬅ Back</button>
    <input type="text" id="editTitle" placeholder="Edit title" aria-label="Edit Note Title" />
    <!-- Changed from textarea to contenteditable div for image rendering -->
    <div id="editContent" contenteditable="true" aria-label="Edit Note Content"></div>
    <input type="file" id="editImageUpload" accept="image/*" />
    <button id="editUploadImageBtn">Upload Image</button>
    <button id="updateNoteBtn">Save Changes</button>
    <button id="deleteNoteBtn" style="background:#dc3545;">Delete Note</button>
  </section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut,
      sendPasswordResetEmail
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      updateDoc,
      deleteDoc,
      doc,
      query,
      orderBy,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDEkpRfo6k8H_arfsnAGyHztWU_sj_pjnY",
      authDomain: "notes-9c204.firebaseapp.com",
      projectId: "notes-9c204",
      storageBucket: "notes-9c204.firebasestorage.app",
      messagingSenderId: "1059724833534",
      appId: "1:1059724833534:web:a6360301650585a248ebaf",
      measurementId: "G-MZ9R21GTQJ"
    };

    const app = initializeApp(firebaseConfig);
    getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const authSection = document.getElementById('authSection');
    const mainMenu = document.getElementById('mainMenu');
    const noteEditor = document.getElementById('noteEditor');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const noteTitleInput = document.getElementById('noteTitle');
    const noteTextInput = document.getElementById('noteText');
    const imageUpload = document.getElementById('imageUpload');
    const uploadImageBtn = document.getElementById('uploadImageBtn');
    const editImageUpload = document.getElementById('editImageUpload');
    const editUploadImageBtn = document.getElementById('editUploadImageBtn');
    const notesContainer = document.getElementById('notesContainer');
    const searchBox = document.getElementById('searchBox');
    const themeToggle = document.getElementById('themeToggle');

    const editTitle = document.getElementById('editTitle');
    const editContent = document.getElementById('editContent'); // contenteditable div now
    const updateNoteBtn = document.getElementById('updateNoteBtn');
    const deleteNoteBtn = document.getElementById('deleteNoteBtn');
    const backBtn = document.getElementById('backBtn');

    const loginBtn = document.getElementById('loginBtn');
    const signupBtn = document.getElementById('signupBtn');
    const resetBtn = document.getElementById('resetBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const saveNoteBtn = document.getElementById('saveNoteBtn');

    let currentUser = null;
    let allNotes = [];
    let editingNoteId = null;

    // THEME TOGGLE
    function loadTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      if(savedTheme === 'dark') {
        document.body.classList.add('dark');
        themeToggle.textContent = '☀️ Toggle Theme';
      } else {
        document.body.classList.remove('dark');
        themeToggle.textContent = '🌙 Toggle Theme';
      }
    }
    function toggleTheme() {
      if(document.body.classList.contains('dark')) {
        document.body.classList.remove('dark');
        themeToggle.textContent = '🌙 Toggle Theme';
        localStorage.setItem('theme', 'light');
      } else {
        document.body.classList.add('dark');
        themeToggle.textContent = '☀️ Toggle Theme';
        localStorage.setItem('theme', 'dark');
      }
    }
    themeToggle.addEventListener('click', toggleTheme);
    loadTheme();

    // AUTH HANDLERS
    signupBtn.onclick = async () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value;
      if (!email || !password) {
        alert('Please enter email and password.');
        return;
      }
      try {
        await createUserWithEmailAndPassword(auth, email, password);
        alert('Sign up successful. You are now logged in.');
      } catch (e) {
        alert('Error signing up: ' + e.message);
      }
    };

    loginBtn.onclick = async () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value;
      if (!email || !password) {
        alert('Please enter email and password.');
        return;
      }
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (e) {
        alert('Error logging in: ' + e.message);
      }
    };

    resetBtn.onclick = async () => {
      const email = emailInput.value.trim();
      if (!email) {
        alert('Please enter your email for password reset.');
        return;
      }
      try {
        await sendPasswordResetEmail(auth, email);
        alert('Password reset email sent.');
      } catch (e) {
        alert('Error sending reset email: ' + e.message);
      }
    };

    logoutBtn.onclick = async () => {
      await signOut(auth);
    };

    onAuthStateChanged(auth, (user) => {
      if(user) {
        currentUser = user;
        authSection.style.display = 'none';
        mainMenu.style.display = '';
        noteEditor.style.display = 'none';
        emailInput.value = '';
        passwordInput.value = '';
        loadNotes();
      } else {
        currentUser = null;
        authSection.style.display = '';
        mainMenu.style.display = 'none';
        noteEditor.style.display = 'none';
        notesContainer.innerHTML = '';
      }
    });

    // Save note with text content and optional images embedded as markdown ![image](url)
    saveNoteBtn.onclick = async () => {
      const title = noteTitleInput.value.trim();
      const content = noteTextInput.value.trim();
      if (!title) {
        alert('Please enter a note title.');
        return;
      }
      try {
        await addDoc(collection(db, 'notes'), {
          uid: currentUser.uid,
          email: currentUser.email,
          title,
          content,
          createdAt: serverTimestamp(),
        });
        noteTitleInput.value = '';
        noteTextInput.value = '';
        imageUpload.value = '';
        alert('Note saved!');
        loadNotes();
      } catch (e) {
        alert('Error saving note: ' + e.message);
      }
    };

    // Load notes for current user
    async function loadNotes() {
      if(!currentUser) return;
      const q = query(collection(db, 'notes'), orderBy('createdAt', 'desc'));
      const snapshot = await getDocs(q);
      allNotes = [];
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        if(data.uid === currentUser.uid) {
          allNotes.push({...data, id: docSnap.id});
        }
      });
      renderNotes(allNotes);
    }

    // Render notes list with previews and clickable to edit
    function renderNotes(notes) {
      notesContainer.innerHTML = '';
      if(notes.length === 0) {
        notesContainer.textContent = 'No notes found.';
        return;
      }
      const searchTerm = searchBox.value.trim().toLowerCase();
      notes.filter(note => {
        return (
          note.title.toLowerCase().includes(searchTerm) ||
          note.content.toLowerCase().includes(searchTerm)
        );
      }).forEach(note => {
        const noteDiv = document.createElement('div');
        noteDiv.className = 'note';
        noteDiv.tabIndex = 0;
        noteDiv.setAttribute('role', 'button');
        noteDiv.setAttribute('aria-label', `Edit note titled ${note.title}`);

        const titleEl = document.createElement('h3');
        titleEl.textContent = note.title;

        // Show a short preview of the content with image URLs replaced by "[Image]"
        let previewText = note.content
          .replace(/!\[.*?\]\((.*?)\)/g, '[Image]')
          .substring(0, 100);
        if(note.content.length > 100) previewText += '...';

        const previewEl = document.createElement('p');
        previewEl.textContent = previewText;

        const dateEl = document.createElement('small');
        if(note.createdAt && note.createdAt.toDate) {
          dateEl.textContent = 'Created: ' + note.createdAt.toDate().toLocaleString();
        }

        noteDiv.appendChild(titleEl);
        noteDiv.appendChild(previewEl);
        noteDiv.appendChild(dateEl);

        noteDiv.onclick = () => openEditor(note);
        noteDiv.onkeypress = (e) => {
          if(e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            openEditor(note);
          }
        };

        notesContainer.appendChild(noteDiv);
      });
    }

    searchBox.addEventListener('input', () => renderNotes(allNotes));

    // Open editor view for editing a note
    function openEditor(note) {
      editingNoteId = note.id;
      mainMenu.style.display = 'none';
      noteEditor.style.display = '';

      editTitle.value = note.title;
      // Convert markdown content to HTML with images embedded in contenteditable div
      editContent.innerHTML = markdownToHTML(note.content);
    }

    // Convert markdown with ![alt](url) images to HTML with <img> tags for contenteditable div
    function markdownToHTML(markdown) {
      // Replace ![alt](url) with <img src="url" alt="alt" class="note-img">
      return markdown.replace(/!\[(.*?)\]\((.*?)\)/g, (match, alt, url) => {
        return `<img src="${url}" alt="${alt}" class="note-img" />`;
      }).replace(/\n/g, '<br>');
    }

    // Convert HTML with <img> tags back to markdown for saving
    function htmlToMarkdown(html) {
      // Create a temporary container
      const container = document.createElement('div');
      container.innerHTML = html;

      // Replace images with markdown ![alt](src)
      container.querySelectorAll('img').forEach(img => {
        const alt = img.alt || '';
        const src = img.src || '';
        const md = `![${alt}](${src})`;
        img.replaceWith(md);
      });

      // Get textContent but keep line breaks for <br>
      // Replace <br> with newlines
      let text = container.innerHTML;
      text = text.replace(/<br\s*\/?>/gi, '\n');
      // Strip other tags (if any)
      text = text.replace(/<\/?[^>]+(>|$)/g, '');
      return text;
    }

    updateNoteBtn.onclick = async () => {
      if(!editingNoteId) return;
      const newTitle = editTitle.value.trim();
      if (!newTitle) {
        alert('Please enter a note title.');
        return;
      }
      const newContentMarkdown = htmlToMarkdown(editContent.innerHTML.trim());
      try {
        const noteRef = doc(db, 'notes', editingNoteId);
        await updateDoc(noteRef, {
          title: newTitle,
          content: newContentMarkdown
        });
        alert('Note updated!');
        editingNoteId = null;
        noteEditor.style.display = 'none';
        mainMenu.style.display = '';
        loadNotes();
      } catch (e) {
        alert('Error updating note: ' + e.message);
      }
    };

    deleteNoteBtn.onclick = async () => {
      if(!editingNoteId) return;
      if(confirm('Are you sure you want to delete this note?')) {
        try {
          await deleteDoc(doc(db, 'notes', editingNoteId));
          alert('Note deleted!');
          editingNoteId = null;
          noteEditor.style.display = 'none';
          mainMenu.style.display = '';
          loadNotes();
        } catch (e) {
          alert('Error deleting note: ' + e.message);
        }
      }
    };

    backBtn.onclick = () => {
      editingNoteId = null;
      noteEditor.style.display = 'none';
      mainMenu.style.display = '';
    };

    // Image uploading from file input - insert markdown into textarea or contenteditable div
    async function uploadImage(file) {
      if(!file) return null;
      // You can implement real upload here if you want; for demo, we'll convert image to base64 data URL
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject('Error reading file');
        reader.readAsDataURL(file);
      });
    }

    uploadImageBtn.onclick = async () => {
      if(imageUpload.files.length === 0) {
        alert('Please select an image to upload.');
        return;
      }
      const file = imageUpload.files[0];
      try {
        const dataUrl = await uploadImage(file);
        // Insert markdown image syntax at end of textarea content
        noteTextInput.value += `\n![${file.name}](${dataUrl})\n`;
        imageUpload.value = '';
      } catch(e) {
        alert('Error uploading image: ' + e);
      }
    };

    editUploadImageBtn.onclick = async () => {
      if(editImageUpload.files.length === 0) {
        alert('Please select an image to upload.');
        return;
      }
      const file = editImageUpload.files[0];
      try {
        const dataUrl = await uploadImage(file);
        // Insert image markdown at caret position in contenteditable div
        insertImageAtCaret(dataUrl, file.name);
        editImageUpload.value = '';
      } catch(e) {
        alert('Error uploading image: ' + e);
      }
    };

    // Insert image markdown in contenteditable div at caret position as actual <img> element
    function insertImageAtCaret(src, alt='Image') {
      const sel = window.getSelection();
      if (!sel || !sel.rangeCount) {
        // Append at end if no selection
        editContent.innerHTML += `<img src="${src}" alt="${alt}" class="note-img" />`;
        return;
      }
      const range = sel.getRangeAt(0);
      range.collapse(false);

      // Create img element
      const img = document.createElement('img');
      img.src = src;
      img.alt = alt;
      img.className = 'note-img';

      // Insert image at caret
      range.insertNode(img);

      // Move caret after inserted image
      range.setStartAfter(img);
      range.collapse(true);

      sel.removeAllRanges();
      sel.addRange(range);
      editContent.focus();
    }

  </script>
</body>
</html>