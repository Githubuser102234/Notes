<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>My Notes</title>
<style>
  :root {
    --bg: #fff;
    --text: #000;
    --card: #f3f3f3;
    --primary: #007bff;
    --primary-hover: #0056b3;
  }
  body.dark {
    --bg: #121212;
    --text: #fff;
    --card: #1f1f1f;
  }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: Arial, sans-serif;
    max-width: 600px;
    margin: auto;
    padding: 20px;
    transition: background-color 0.3s, color 0.3s;
  }
  input, textarea, button {
    width: 100%;
    margin: 8px 0;
    padding: 10px;
    font-size: 16px;
    box-sizing: border-box;
    border: 1px solid #ccc;
    border-radius: 4px;
    background: var(--card);
    color: var(--text);
    transition: background-color 0.3s, color 0.3s;
  }
  input::placeholder, textarea::placeholder {
    color: #666;
  }
  button {
    background: var(--primary);
    color: white;
    cursor: pointer;
    border: none;
    transition: background-color 0.3s;
  }
  button:hover {
    background: var(--primary-hover);
  }
  .note {
    background: var(--card);
    padding: 10px;
    border-radius: 5px;
    margin: 10px 0;
    user-select: none;
    transition: background-color 0.3s;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
  }
  .note:hover {
    background: var(--primary);
    color: white;
  }
  .note h3 {
    margin: 0 0 5px;
    word-break: break-word;
  }
  .note p {
    margin: 0;
    font-size: 14px;
    color: inherit;
    word-break: break-word;
  }
  .note small {
    display: block;
    margin-top: 8px;
    font-size: 12px;
    color: gray;
    user-select: text;
  }
  .note-content {
    flex-grow: 1;
  }
  .share-btn {
    margin-left: 12px;
    background: #28a745;
    border-radius: 4px;
    padding: 6px 10px;
    font-size: 14px;
    cursor: pointer;
    flex-shrink: 0;
  }
  .share-btn:hover {
    background: #218838;
  }
  #themeToggle {
    float: right;
    margin-top: -38px;
    width: auto;
    padding: 8px 12px;
    font-size: 14px;
    border-radius: 20px;
  }
  #noteEditor {
    display: none;
  }
  #searchBox {
    margin-top: 16px;
  }
  #publicView {
    display: none;
    background: var(--card);
    padding: 15px;
    border-radius: 8px;
  }
  #publicView h2 {
    margin-top: 0;
  }
</style>
</head>
<body>

<h1>My Notes</h1>
<button id="themeToggle" aria-label="Toggle Dark/Light Theme">🌙 Toggle Theme</button>

<section id="authSection" aria-label="User Authentication">
  <input type="email" id="email" placeholder="Email" autocomplete="username" />
  <input type="password" id="password" placeholder="Password" autocomplete="current-password" />
  <button id="loginBtn">Login</button>
  <button id="signupBtn">Sign Up</button>
  <button id="resetBtn">Reset Password</button>
</section>

<section id="mainMenu" style="display:none;" aria-label="Main Note Taking Area">
  <button id="logoutBtn">Logout</button>
  <input type="text" id="noteTitle" placeholder="Note title" aria-label="Note Title" />
  <textarea id="noteText" rows="3" placeholder="Write your note..." aria-label="Note Content"></textarea>
  <button id="saveNoteBtn">Save Note</button>

  <input type="text" id="searchBox" placeholder="Search notes..." aria-label="Search Notes" />

  <h2>Your Notes</h2>
  <div id="notesContainer" aria-live="polite" aria-relevant="additions"></div>
</section>

<section id="noteEditor" aria-label="Edit Note">
  <button id="backBtn" aria-label="Back to Notes List">⬅ Back</button>
  <input type="text" id="editTitle" placeholder="Edit title" aria-label="Edit Note Title" />
  <textarea id="editContent" rows="10" aria-label="Edit Note Content"></textarea>
  <button id="updateNoteBtn">Save Changes</button>
  <button id="deleteNoteBtn" style="background:#dc3545;">Delete Note</button>
</section>

<section id="publicView" aria-label="Shared Note View">
  <h2 id="publicTitle"></h2>
  <p id="publicContent"></p>
  <button id="closePublicBtn">Close</button>
</section>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";
  import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    onAuthStateChanged,
    signOut,
    sendPasswordResetEmail
  } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    updateDoc,
    deleteDoc,
    doc,
    query,
    orderBy,
    serverTimestamp,
    where,
    limit
  } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDEkpRfo6k8H_arfsnAGyHztWU_sj_pjnY",
    authDomain: "notes-9c204.firebaseapp.com",
    projectId: "notes-9c204",
    storageBucket: "notes-9c204.appspot.com",
    messagingSenderId: "1059724833534",
    appId: "1:1059724833534:web:a6360301650585a248ebaf",
    measurementId: "G-MZ9R21GTQJ"
  };

  const app = initializeApp(firebaseConfig);
  getAnalytics(app);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // UI Elements
  const authSection = document.getElementById('authSection');
  const mainMenu = document.getElementById('mainMenu');
  const noteEditor = document.getElementById('noteEditor');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const noteTitleInput = document.getElementById('noteTitle');
  const noteTextInput = document.getElementById('noteText');
  const notesContainer = document.getElementById('notesContainer');
  const searchBox = document.getElementById('searchBox');
  const themeToggle = document.getElementById('themeToggle');

  const editTitle = document.getElementById('editTitle');
  const editContent = document.getElementById('editContent');
  const updateNoteBtn = document.getElementById('updateNoteBtn');
  const deleteNoteBtn = document.getElementById('deleteNoteBtn');
  const backBtn = document.getElementById('backBtn');

  // Public view elements
  const publicView = document.getElementById('publicView');
  const publicTitle = document.getElementById('publicTitle');
  const publicContent = document.getElementById('publicContent');
  const closePublicBtn = document.getElementById('closePublicBtn');

  let currentUser = null;
  let currentNoteId = null;
  let notes = [];

  // Theme functions
  const saveTheme = () => {
    localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light");
  };
  const loadTheme = () => {
    const theme = localStorage.getItem("theme") || "light";
    if (theme === "dark") {
      document.body.classList.add("dark");
      themeToggle.textContent = "☀️ Toggle Theme";
    } else {
      document.body.classList.remove("dark");
      themeToggle.textContent = "🌙 Toggle Theme";
    }
  };

  themeToggle.addEventListener('click', () => {
    document.body.classList.toggle("dark");
    saveTheme();
    if(document.body.classList.contains("dark")) {
      themeToggle.textContent = "☀️ Toggle Theme";
    } else {
      themeToggle.textContent = "🌙 Toggle Theme";
    }
  });
  loadTheme();

  // Show/hide views
  const showAuth = () => {
    authSection.style.display = "block";
    mainMenu.style.display = "none";
    noteEditor.style.display = "none";
    publicView.style.display = "none";
  };
  const showMainMenu = () => {
    authSection.style.display = "none";
    mainMenu.style.display = "block";
    noteEditor.style.display = "none";
    publicView.style.display = "none";
  };
  const showNoteEditor = () => {
    authSection.style.display = "none";
    mainMenu.style.display = "none";
    noteEditor.style.display = "block";
    publicView.style.display = "none";
  };
  const showPublicView = () => {
    authSection.style.display = "none";
    mainMenu.style.display = "none";
    noteEditor.style.display = "none";
    publicView.style.display = "block";
  };

  // Helper: generate short random hash (12 chars)
  function generateHash() {
    const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let result = '';
    for(let i=0; i<12; i++) {
      result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
  }

  // Auth handlers
  document.getElementById('loginBtn').addEventListener('click', async () => {
    try {
      await signInWithEmailAndPassword(auth, emailInput.value.trim(), passwordInput.value);
    } catch(e) {
      alert("Login failed: " + e.message);
    }
  });
  document.getElementById('signupBtn').addEventListener('click', async () => {
    try {
      await createUserWithEmailAndPassword(auth, emailInput.value.trim(), passwordInput.value);
      alert("Account created. Please log in.");
    } catch(e) {
      alert("Sign Up failed: " + e.message);
    }
  });
  document.getElementById('resetBtn').addEventListener('click', async () => {
    try {
      await sendPasswordResetEmail(auth, emailInput.value.trim());
      alert("Password reset email sent.");
    } catch(e) {
      alert("Reset failed: " + e.message);
    }
  });
  document.getElementById('logoutBtn').addEventListener('click', () => {
    signOut(auth);
  });

  // Load notes for current user
  async function loadNotes() {
    if (!currentUser) return;
    notesContainer.innerHTML = "Loading notes...";
    notes = [];
    try {
      const q = query(collection(db, "notes"), where("uid", "==", currentUser.uid), orderBy("createdAt", "desc"));
      const snapshot = await getDocs(q);
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        notes.push({ id: docSnap.id, ...data });
      });
      displayNotes();
    } catch(e) {
      notesContainer.innerHTML = "Failed to load notes: " + e.message;
    }
  }

  // Display notes with search filter
  function displayNotes() {
    const searchTerm = searchBox.value.trim().toLowerCase();
    notesContainer.innerHTML = "";
    let filtered = notes.filter(note =>
      note.title.toLowerCase().includes(searchTerm) ||
      note.content.toLowerCase().includes(searchTerm)
    );
    if (filtered.length === 0) {
      notesContainer.innerHTML = "<p>No notes found.</p>";
      return;
    }
    for (let note of filtered) {
      const noteEl = document.createElement("div");
      noteEl.className = "note";
      noteEl.setAttribute("tabindex", "0");
      noteEl.innerHTML = `
        <div class="note-content">
          <h3>${escapeHtml(note.title)}</h3>
          <p>${escapeHtml(note.content.substring(0, 80))}${note.content.length > 80 ? "..." : ""}</p>
          <small>Created: ${note.createdAt?.toDate ? note.createdAt.toDate().toLocaleString() : "Unknown"}</small>
        </div>
        <button class="share-btn" aria-label="Share note ${escapeHtml(note.title)}">Share</button>
      `;
      noteEl.addEventListener("click", (ev) => {
        if(ev.target.classList.contains("share-btn")) {
          shareNoteLink(note);
          ev.stopPropagation();
          return;
        }
        openEditor(note.id);
      });
      noteEl.addEventListener("keypress", e => {
        if(e.key === "Enter" || e.key === " ") {
          openEditor(note.id);
        }
      });
      notesContainer.appendChild(noteEl);
    }
  }

  // Escape HTML
  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // Open editor for a note
  function openEditor(id) {
    currentNoteId = id;
    const note = notes.find(n => n.id === id);
    if (!note) return;
    editTitle.value = note.title;
    editContent.value = note.content;
    showNoteEditor();
  }

  // Save new note
  document.getElementById('saveNoteBtn').addEventListener('click', async () => {
    const title = noteTitleInput.value.trim();
    const content = noteTextInput.value.trim();
    if (!title && !content) {
      alert("Please enter a title or content");
      return;
    }
    try {
      const hash = generateHash();
      await addDoc(collection(db, "notes"), {
        uid: currentUser.uid,
        title,
        content,
        hash,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });
      noteTitleInput.value = "";
      noteTextInput.value = "";
      await loadNotes();
    } catch(e) {
      alert("Failed to save note: " + e.message);
    }
  });

  // Update existing note
  updateNoteBtn.addEventListener('click', async () => {
    if (!currentNoteId) return;
    const title = editTitle.value.trim();
    const content = editContent.value.trim();
    if (!title && !content) {
      alert("Please enter a title or content");
      return;
    }
    try {
      const noteRef = doc(db, "notes", currentNoteId);
      await updateDoc(noteRef, {
        title,
        content,
        updatedAt: serverTimestamp()
      });
      await loadNotes();
      showMainMenu();
    } catch(e) {
      alert("Failed to update note: " + e.message);
    }
  });

  // Delete note
  deleteNoteBtn.addEventListener('click', async () => {
    if (!currentNoteId) return;
    if (!confirm("Are you sure you want to delete this note?")) return;
    try {
      await deleteDoc(doc(db, "notes", currentNoteId));
      currentNoteId = null;
      await loadNotes();
      showMainMenu();
    } catch(e) {
      alert("Failed to delete note: " + e.message);
    }
  });

  backBtn.addEventListener('click', () => {
    showMainMenu();
  });

  // Search box event
  searchBox.addEventListener('input', displayNotes);

  // Auth state observer
  onAuthStateChanged(auth, async user => {
    currentUser = user;
    if (user) {
      showMainMenu();
      await loadNotes();
    } else {
      showAuth();
    }
  });

  // Share note - show alert with link containing hash param in URL hash (#note=...)
  function shareNoteLink(note) {
    if (!note.hash) {
      alert("Note does not have a share hash.");
      return;
    }
    const baseUrl = window.location.href.split('#')[0];
    const shareUrl = `${baseUrl}#note=${note.hash}`;
    navigator.clipboard.writeText(shareUrl).then(() => {
      alert("Share link copied to clipboard:\n" + shareUrl);
    }, () => {
      alert("Share link:\n" + shareUrl);
    });
  }

  // Public view (shared note by hash)
  async function showSharedNoteByHash(hash) {
    publicTitle.textContent = "Loading...";
    publicContent.textContent = "";
    showPublicView();
    try {
      // Query notes collection for the hash
      const q = query(collection(db, "notes"), where("hash", "==", hash), limit(1));
      const snapshot = await getDocs(q);
      if (snapshot.empty) {
        publicTitle.textContent = "Note not found.";
        return;
      }
      const docSnap = snapshot.docs[0];
      const data = docSnap.data();
      publicTitle.textContent = data.title || "(No title)";
      publicContent.textContent = data.content || "(No content)";
    } catch (e) {
      publicTitle.textContent = "Error loading note.";
      publicContent.textContent = e.message;
    }
  }

  closePublicBtn.addEventListener('click', () => {
    // Clear hash and reload to show normal UI
    window.location.hash = "";
    location.reload();
  });

  // On page load, check URL hash for shared note
  window.addEventListener('load', () => {
    const hash = window.location.hash;
    if (hash.startsWith("#note=")) {
      const noteHash = hash.slice(6);
      showSharedNoteByHash(noteHash);
    }
  });

</script>
</body>
</html>